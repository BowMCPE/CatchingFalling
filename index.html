<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch the Falling Objects</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
            background: linear-gradient(to bottom, #1e90ff, #ffcccb); /* Colorful theme */
        }
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        #menu button {
            background: #FF4500;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            margin: 10px;
            cursor: pointer;
        }
        #score, #coins, #level {
            position: absolute;
            color: white;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        #score { top: 10px; left: 10px; }
        #coins { top: 10px; right: 10px; }
        #level { top: 50px; left: 10px; }
        .power-up {
            position: absolute;
            background-color: yellow;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Welcome to the Game</h1>
        <button id="loginButton">Login with Google</button>
        <button id="guestButton">Play as Guest</button>
        <div id="userInfo" style="display: none;">
            <h2 id="username"></h2>
            <button id="startGame">Start Game</button>
        </div>
    </div>
    <div id="score">Score: 0</div>
    <div id="coins">Coins: 0</div>
    <div id="level">Level: 1</div>
    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDaABc6bOm9Xe_ziIpm81CREJ1PUtuHXeQ",
            authDomain: "auth-29641.firebaseapp.com",
            databaseURL: "https://auth-29641-default-rtdb.firebaseio.com",
            projectId: "auth-29641",
            storageBucket: "auth-29641.appspot.com",
            messagingSenderId: "18460799597",
            appId: "1:18460799597:web:a081c485cb4f593ce38564"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // DOM Elements
        const loginButton = document.getElementById("loginButton");
        const guestButton = document.getElementById("guestButton");
        const userInfo = document.getElementById("userInfo");
        const username = document.getElementById("username");
        const startGameButton = document.getElementById("startGame");
        const scoreDiv = document.getElementById("score");
        const coinsDiv = document.getElementById("coins");
        const levelDiv = document.getElementById("level");

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Game Variables
        let score = 0;
        let coins = 0;
        let level = 1;
        let isGameRunning = false;
        let userId = null;
        let missedObjects = 0;
        const bucket = {
            x: canvas.width / 2 - 50,
            y: canvas.height - 30,
            width: 100,
            height: 20,
            speed: 20,
            skin: "red" // Default skin
        };
        let objects = [];
        let powerUps = [];

        // Firebase Auth
        loginButton.addEventListener("click", () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    userId = user.uid;
                    username.innerText = `Welcome, ${user.displayName.replace(/[<>]/g, "")}`;
                    loginButton.style.display = "none";
                    guestButton.style.display = "none";
                    userInfo.style.display = "block";
                    loadProgress(userId);
                })
                .catch((error) => alert("Failed to log in. Please try again."));
        });

        // Guest mode
        guestButton.addEventListener("click", () => {
            userId = null;
            username.innerText = "Playing as Guest";
            loginButton.style.display = "none";
            guestButton.style.display = "none";
            userInfo.style.display = "block";
            resetGameState();
        });

        // Firebase Database
        function loadProgress(userId) {
            get(child(ref(database), `users/${userId}`))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        score = data.score ?? 0;
                        coins = data.coins ?? 0;
                        level = data.level ?? 1;
                        updateUI();
                    }
                })
                .catch(() => alert("Failed to load progress."));
        }

        function saveProgress(userId) {
            if (userId) {
                set(ref(database, `users/${userId}`), {
                    score,
                    coins,
                    level
                }).catch(() => alert("Failed to save progress."));
            }
        }

        function updateUI() {
            scoreDiv.innerText = `Score: ${score}`;
            coinsDiv.innerText = `Coins: ${coins}`;
            levelDiv.innerText = `Level: ${level}`;
        }

        // Game Initialization
        startGameButton.addEventListener("click", () => {
            if (isGameRunning) return;
            isGameRunning = true;
            resetGameState();
            document.getElementById("menu").style.display = "none";
            gameLoop();
        });

        function resetGameState() {
            score = 0;
            coins = 0;
            level = 1;
            objects = [];
            powerUps = [];
            missedObjects = 0;
            bucket.skin = "red"; // Reset skin
            updateUI();
        }

        // Power-ups
        function generatePowerUp() {
            const x = Math.random() * canvas.width;
            powerUps.push({ x, y: 0, speed: 2, type: "boost" });
        }

        function gameLoop() {
            if (!isGameRunning) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw bucket
            ctx.fillStyle = bucket.skin;
            ctx.fillRect(bucket.x, bucket.y, bucket.width, bucket.height);

            // Draw falling objects
            objects.forEach((obj, index) => {
                ctx.fillStyle = "gold";
                ctx.fillRect(obj.x, obj.y, 20, 20);
                obj.y += obj.speed;

                // Collision with bucket
                if (
                    obj.x < bucket.x + bucket.width &&
                    obj.x + 20 > bucket.x &&
                    obj.y < bucket.y + bucket.height &&
                    obj.y + 20 > bucket.y
                ) {
                    objects.splice(index, 1);
                    score++;
                    coins++;
                    updateUI();
                }

                // Missed objects
                if (obj.y > canvas.height) {
                    objects.splice(index, 1);
                    missedObjects++;
                    if (missedObjects > 3) {
                        isGameRunning = false;
                        alert("Game Over!");
                        saveProgress(userId);
                    }
                }
            });

            // Draw power-ups
            powerUps.forEach((power, index) => {
                ctx.fillStyle = "blue";
                ctx.fillRect(power.x, power.y, 20, 20);
                power.y += power.speed;

                // Power-up collision
                if (
                    power.x < bucket.x + bucket.width &&
                    power.x + 20 > bucket.x &&
                    power.y < bucket.y + bucket.height &&
                    power.y + 20 > bucket.y
                ) {
                    powerUps.splice(index, 1);
                    bucket.skin = "blue"; // Example: Boost
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // Generate objects and power-ups
        setInterval(() => {
            if (isGameRunning) {
                const x = Math.random() * canvas.width;
                objects.push({ x, y: 0, speed: Math.min(5 + level * 0.5, 15) });
                if (Math.random() < 0.1) generatePowerUp(); // Random power-up
            }
        }, 1000);

        window.addEventListener("keydown", (e) => {
            if (e.key === "ArrowLeft") bucket.x = Math.max(0, bucket.x - bucket.speed);
            if (e.key === "ArrowRight") bucket.x = Math.min(canvas.width - bucket.width, bucket.x + bucket.speed);
        });

        window.addEventListener("resize", () => {
            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            bucket.x = (bucket.x / oldWidth) * canvas.width;
            objects.forEach((obj) => {
                obj.x = (obj.x / oldWidth) * canvas.width;
                obj.y = (obj.y / oldHeight) * canvas.height;
            });
        });
    </script>
</body>
</html>
