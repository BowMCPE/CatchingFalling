<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch the Falling Objects</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
            background: linear-gradient(to bottom, #1e90ff, #ffcccb);
        }
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        #menu button {
            background: #FF4500;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            margin: 10px;
            cursor: pointer;
        }
        #score, #coins, #level {
            position: absolute;
            color: white;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        #score { top: 10px; left: 10px; }
        #coins { top: 10px; right: 10px; }
        #level { top: 50px; left: 10px; }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Catch the Falling Objects</h1>
        <button id="loginButton">Login with Google</button>
        <button id="guestButton">Play as Guest</button>
    </div>
    <div id="score">Score: 0</div>
    <div id="coins">Coins: 0</div>
    <div id="level">Level: 1</div>
    <canvas id="gameCanvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDaABc6bOm9Xe_ziIpm81CREJ1PUtuHXeQ",
            authDomain: "auth-29641.firebaseapp.com",
            databaseURL: "https://auth-29641-default-rtdb.firebaseio.com",
            projectId: "auth-29641",
            storageBucket: "auth-29641.appspot.com",
            messagingSenderId: "18460799597",
            appId: "1:18460799597:web:a081c485cb4f593ce38564"
        };

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // DOM Elements
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const loginButton = document.getElementById("loginButton");
        const guestButton = document.getElementById("guestButton");
        const scoreDiv = document.getElementById("score");
        const coinsDiv = document.getElementById("coins");
        const levelDiv = document.getElementById("level");

        // Canvas Setup
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Game Variables
        let score = 0;
        let coins = 0;
        let level = 1;
        let missedObjects = 0;
        const maxMissed = 5;
        let isGameRunning = false;
        let objects = [];
        const bucket = {
            x: canvas.width / 2 - 50,
            y: canvas.height - 30,
            width: 100,
            height: 20,
            speed: 20,
            color: "red"
        };

        // Functions
        function spawnObject() {
            const size = Math.random() * 20 + 20;
            objects.push({
                x: Math.random() * (canvas.width - size),
                y: -size,
                width: size,
                height: size,
                speed: Math.random() * 2 + level // Speed increases with level
            });
        }

        function drawBucket() {
            ctx.fillStyle = bucket.color;
            ctx.fillRect(bucket.x, bucket.y, bucket.width, bucket.height);
        }

        function drawObjects() {
            ctx.fillStyle = "orange";
            objects.forEach(obj => {
                ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
            });
        }

        function updateObjects() {
            objects.forEach(obj => obj.y += obj.speed);
            objects = objects.filter(obj => {
                if (obj.y > canvas.height) {
                    missedObjects++;
                    return false;
                }
                const isCaught = obj.y + obj.height >= bucket.y &&
                                 obj.x < bucket.x + bucket.width &&
                                 obj.x + obj.width > bucket.x;
                if (isCaught) {
                    score += 10;
                    coins += 1;
                    return false;
                }
                return true;
            });

            if (missedObjects >= maxMissed) {
                isGameRunning = false;
                alert("Game Over! Reload to play again.");
            }
        }

        function updateUI() {
            scoreDiv.textContent = `Score: ${score}`;
            coinsDiv.textContent = `Coins: ${coins}`;
            levelDiv.textContent = `Level: ${level}`;
        }

        function checkLevelUp() {
            if (score >= level * 100) { // Example: Level up every 100 points
                level++;
            }
        }

        function gameLoop() {
            if (!isGameRunning) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBucket();
            drawObjects();
            updateObjects();
            checkLevelUp();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function loginWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(result => {
                    const user = result.user;
                    loadProgress(user.uid);
                    isGameRunning = true;
                    gameLoop();
                })
                .catch(error => {
                    alert("Login failed: " + error.message);
                    console.error(error);
                });
        }

        function saveProgress(userId) {
            set(ref(database, `users/${userId}`), {
                score,
                coins,
                level,
                bucketColor: bucket.color
            }).catch(console.error);
        }

        function loadProgress(userId) {
            const userRef = ref(database, `users/${userId}`);
            get(userRef).then(snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    score = data.score || 0;
                    coins = data.coins || 0;
                    level = data.level || 1;
                    bucket.color = data.bucketColor || "red";
                    updateUI();
                }
            }).catch(console.error);
        }

        // Event Listeners
        document.addEventListener("keydown", event => {
            if (event.key === "ArrowLeft") bucket.x = Math.max(0, bucket.x - bucket.speed);
            if (event.key === "ArrowRight") bucket.x = Math.min(canvas.width - bucket.width, bucket.x + bucket.speed);
        });

        canvas.addEventListener("touchmove", event => {
            const touchX = event.touches[0].clientX;
            bucket.x = Math.min(canvas.width - bucket.width, Math.max(0, touchX - bucket.width / 2));
        });

        loginButton.addEventListener("click", loginWithGoogle);
        guestButton.addEventListener("click", () => {
            isGameRunning = true;
            gameLoop();
        });

        // Spawn objects periodically
        setInterval(() => {
            if (isGameRunning) spawnObject();
        }, 1000);

        // Save progress periodically
        setInterval(() => {
            if (auth.currentUser && isGameRunning) saveProgress(auth.currentUser.uid);
        }, 5000);
    </script>
</body>
</html>
